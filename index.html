<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <title>Hodgkin-Huxley Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        html,
        body {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .container-fluid {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .header-row,
        .content-row {
            width: 100%;
        }

        .content-row {
            flex-grow: 1;
            display: flex;
        }

        #plot-column {
            flex-grow: 10;
            display: flex;
            flex-direction: column;
        }

        #controls-column {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            max-width: 25%;
        }

        #txt-points {
            flex-grow: 1;
            min-height: 150px;
            flex-direction: column;
        }
    </style>
</head>

<body>
    <div class="container-fluid text-center">
        <div class="header-row">
            <h3>Hodgkin-Huxley Simulation</h3>
        </div>
        <div class="content-row">
            <div id="plot-column" class="col">
                <div id="div-plot" class="container" style="flex-grow: 1;">Loading please wait</div>
            </div>
            <div id="controls-column" class="col-auto">
                <div class="row form-group">
                    <label for="select-example" class="col-sm-4 col-form-label text-sm-right">Example Scenarios</label>
                    <div class="col-sm-8">
                        <select id="select-example" class="form-control">
                            <option>Single action potential</option>
                            <option>Multiple action potentials</option>
                            <option>Refactory period</option>
                            <option>Accommodation</option>
                            <option>Pulse-width modulation</option>
                            <option>Temporal summation</option>
                        </select>
                    </div>
                </div>
                <div class="row form-group">
                    <label for="select-solver" class="col-sm-4 col-form-label text-sm-right">Solver</label>
                    <div class="col-sm-8">
                        <select id="select-solver" class="form-control">
                            <option>Dormand-Prince</option>
                            <option>Runge-Kutta</option>
                            <option>Euler</option>
                        </select>
                    </div>
                </div>
                <div class="row form-group align-items-center">
                    <label for="input-duration" class="col-sm-4 col-form-label text-sm-right">Duration (ms)</label>
                    <div class="col-sm-8">
                        <input id="input-duration" type="number" class="form-control" placeholder="Enter duration in ms"
                            required>
                    </div>
                    <label for="input-timestep" class="col-sm-4 col-form-label text-sm-right">Time step (ms)</label>
                    <div class="col-sm-8">
                        <input id="input-timestep" type="number" class="form-control"
                            placeholder="Enter time step in ms" required>
                    </div>
                </div>
                <label for="txt-points" class="form-label">Input points (Time $t_0$, Duration $ms$, Strength
                    $mV$)</label>
                <textarea id="txt-points" class="form-control" placeholder="Enter code here..." required></textarea>
                <div class="btn-group-vertical" role="group" aria-label="Plot Controls">
                    <button id="btn-update" class="btn btn-primary">Update Plot</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>


    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
        </script>

    <script src="https://cdn.plot.ly/plotly-2.31.1.min.js" charset="utf-8"></script>
    <script src='pkg/wasm_test.js'></script>
    <script>
        function cb_example() {
            let select_example = document.getElementById("select-example");
            let txt_points = document.getElementById("txt-points");
            let duration = document.getElementById("input-duration");
            let timesteps = document.getElementById("input-timestep");
            timesteps.value = 0.1;
            select_solver.value = "Dormand-Prince";
            switch (select_example.value) {
                case "Single action potential":
                    txt_points.value = "10, 1, 20";
                    duration.value = 30;
                    break;
                case "Multiple action potentials":
                    txt_points.value = "10, 2, 15\n20, 2, 15\n20, 2, 15";
                    duration.value = 70;
                    break;
                case "Refactory period":
                    txt_points.value = "10, 5, 5\n5, 5, 10";
                    duration.value = 40;
                    break;
                case "Accommodation":
                    txt_points.value = "10, 25, 5";
                    duration.value = 40;
                    break;
                case "Pulse-width modulation":
                    txt_points.value = "10, 80, 30";
                    duration.value = 100;
                    break;
                case "Temporal summation":
                    txt_points.value = "5, 0.3, 20\n10, 0.3, 20\n2, 0.3, 20\n14, 0.3, 20\n5, 0.3, 20";
                    duration.value = 40;
                    break;
            }
            applet.set_solver(SolverType.Dopri);
            applet.set_duration(duration.value);
            applet.set_timestep(timesteps.value);
            applet.plot();
        }

        function cb_solver() {
            let select_solver = document.getElementById("select-solver");
            switch (select_solver.value) {
                case "Dormand-Prince":
                    timesteps.value = 0.1;
                    applet.set_timestep(timesteps.value);
                    applet.set_solver(SolverType.Dopri);
                    break;
                case "Runge-Kutta":
                    timesteps.value = 0.01;
                    applet.set_timestep(timesteps.value);
                    applet.set_solver(SolverType.RK4);
                    break;
                case "Euler":
                    timesteps.value = 0.01;
                    applet.set_timestep(timesteps.value);
                    applet.set_solver(SolverType.Euler);
                    break;
            }
            applet.plot();
        }

        let plot_div = document.getElementById("div-plot");
        let txt_points = document.getElementById("txt-points");
        let duration = document.getElementById("input-duration");
        let timesteps = document.getElementById("input-timestep");
        let select_solver = document.getElementById("select-solver");
        let btn_update = document.getElementById("btn-update");
        let select_example = document.getElementById("select-example");
        duration.addEventListener("input", () => applet.set_duration(duration.value));
        duration.addEventListener("change", () => applet.set_duration(duration.value));
        timesteps.addEventListener("input", () => applet.set_timestep(timesteps.value));
        timesteps.addEventListener("change", () => applet.set_timestep(timesteps.value));
        btn_update.addEventListener("click", () => applet.plot());
        select_example.addEventListener("change", cb_example);
        select_solver.addEventListener("change", cb_solver);
        txt_points.value = "30, 10, 5";

        async function run() {
            await wasm_bindgen();
            let applet = wasm_bindgen.APApplet.new(plot_div, txt_points, 100);
            window.applet = applet;
            window.SolverType = wasm_bindgen.SolverType;
            cb_example();
            cb_solver();
        }
        run();
    </script>
</body>

</html>